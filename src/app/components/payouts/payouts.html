<app-layout
  pageTitle="Payout Management"
  pageDescription="Manage writer payouts and earnings"
  [showRefreshButton]="true"
  [showAddButton]="false"
>
  <div class="container-fluid py-4">
    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="flex-shrink-0">
                <div class="bg-warning bg-opacity-10 rounded-3 p-3">
                  <i class="pi pi-clock text-warning fs-4"></i>
                </div>
              </div>
              <div class="flex-grow-1 ms-3">
                <h6 class="text-muted mb-1 fw-semibold">Pending Payouts</h6>
                <h4 class="mb-0 fw-bold text-dark">
                  {{ formatCurrency(totalPendingAmount.toString()) }}
                </h4>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="flex-shrink-0">
                <div class="bg-success bg-opacity-10 rounded-3 p-3">
                  <i class="pi pi-check-circle text-success fs-4"></i>
                </div>
              </div>
              <div class="flex-grow-1 ms-3">
                <h6 class="text-muted mb-1 fw-semibold">Completed Payouts</h6>
                <h4 class="mb-0 fw-bold text-dark">
                  {{ formatCurrency(totalProcessedAmount.toString()) }}
                </h4>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters and Search -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text">
                <i class="pi pi-search"></i>
              </span>
              <input
                type="text"
                class="form-control"
                placeholder="Search by writer name or email..."
                [(ngModel)]="searchTerm"
                (input)="onSearch()"
              />
            </div>
          </div>
          <div class="col-md-3">
            <select class="form-select" [(ngModel)]="selectedFilter" (change)="onFilterChange()">
              <option value="All Payouts">All Payouts</option>
              <option value="Pending">Pending</option>
              <option value="Processing">Processing</option>
              <option value="Completed">Completed</option>
              <option value="Failed">Failed</option>
            </select>
          </div>
          <div class="col-md-3">
            <div class="text-muted small">
              Showing {{ filteredPayouts.length }} of {{ payouts.length }} payouts
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Payouts Table -->
    <div class="card border-0 shadow-sm">
      <div class="card-body p-0">
        @if (isLoading) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Loading payouts...</p>
        </div>
        } @else if (filteredPayouts.length === 0) {
        <div class="text-center py-5">
          <i class="pi pi-wallet fs-1 text-muted mb-3"></i>
          <h5 class="text-muted">No payouts found</h5>
          <p class="text-muted">Try adjusting your search or filter criteria</p>
        </div>
        } @else {
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Payout ID</th>
                <th>Writer</th>
                <th>Amount</th>
                <th>Payment Method</th>
                <th>Status</th>
                <th>Requested</th>
                <th>Processed</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (payout of filteredPayouts; track payout.id) {
              <tr>
                <td>
                  <span class="fw-semibold">#{{ payout.id }}</span>
                </td>
                <td>
                  <div>
                    <div class="fw-semibold">{{ payout.writer_name }}</div>
                    <small class="text-muted">{{ payout.writer_email }}</small>
                  </div>
                </td>
                <td>
                  <span class="fw-bold text-success">{{ formatCurrency(payout.amount) }}</span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <i class="pi me-2" [class]="getPaymentMethodIcon(payout.payment_method)"></i>
                    <div>
                      <div class="fw-semibold">{{ payout.payment_method }}</div>
                      <small class="text-muted">{{ payout.payment_details }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="badge" [class]="getStatusClass(payout.status)">
                    {{ getStatusText(payout.status) }}
                  </span>
                  @if (payout.status === 'failed' && payout.failure_reason) {
                  <div class="small text-danger mt-1">
                    {{ payout.failure_reason }}
                  </div>
                  }
                </td>
                <td>
                  <small class="text-muted">{{ formatDateTime(payout.requested_at) }}</small>
                </td>
                <td>
                  @if (payout.processed_at) {
                  <small class="text-muted">{{ formatDateTime(payout.processed_at) }}</small>
                  } @else {
                  <span class="text-muted">-</span>
                  }
                </td>
                <td>
                  @if (userRole === 'admin') {
                  <div class="btn-group btn-group-sm">
                    @if (payout.status === 'pending') {
                    <button
                      class="btn btn-outline-success"
                      (click)="onApprovePayout(payout)"
                      title="Approve Payout"
                    >
                      <i class="pi pi-check"></i>
                    </button>
                    <button
                      class="btn btn-outline-danger"
                      (click)="onRejectPayout(payout)"
                      title="Reject Payout"
                    >
                      <i class="pi pi-times"></i>
                    </button>
                    } @if (payout.status === 'processing') {
                    <button
                      class="btn btn-outline-primary"
                      (click)="onMarkCompleted(payout)"
                      title="Mark as Completed"
                    >
                      <i class="pi pi-check-circle"></i>
                    </button>
                    } @if (payout.status === 'failed') {
                    <button
                      class="btn btn-outline-warning"
                      (click)="onRetryPayout(payout)"
                      title="Retry Payout"
                    >
                      <i class="pi pi-refresh"></i>
                    </button>
                    }
                  </div>
                  } @else {
                  <span class="text-muted">-</span>
                  }
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
        }
      </div>
    </div>
  </div>
</app-layout>
